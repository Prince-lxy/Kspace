# Cortex-M3

> Cortex-M3

## Contents / Mind mapping
- **1 Cortex-M3 MCU**
  - **1.1 Cortex-M3 内核**

---

### 1 Cortex-M3 MCU

Cortex-M3 MCU（微控制器单元）包含 Cortex-M3 处理器内核、调试系统、内部总线、外设、存储器、时钟、I/O。其中的内核和调试系统由 ARM 公司设计，其他部分由生产芯片的厂商设计开发。

#### 1.1 Cortex-M3 内核

- 架构：
  - Cortex‐M3 内核是一个 32 位处理器。内部的数据路径是 32 位的，寄存器是 32 位的，存储器接口也是 32 位的。
  - CM3 采用了哈佛结构，拥有独立的指令总线和数据总线，可以让取指与数据访问并行不悖。另一方面，指令总线和数据总线共享同一个存储器空间（一个统一的存储器系统）。换句话说，不是因为有两条总线，可寻址空间就变成 8GB 了。
- Cortex-M3 组件
  - Processor Core System
    - NVIC（嵌套向量中断控制器）
    - Instruction Fetch Unit
    - Decoder
    - Register Bank
    - ALU
    - Memory Interface（存储器接口）
    - Trace Interface
  - Memory Protection Unit（存储器保护单元）
  - Bus Interconnect
    - Instruction Bus
    - Data Bus
  - Debug System
    - Debug Interface
- 寄存器
  - 通用寄存器（R0-R12）
    - 注
      - 绝大多数 16 位 Thumb 指令只能访问 R0‐R7，而 32 位 Thumb‐2 指令可以访问所有寄存器。
  - 堆栈指针寄存器（R13）
    - 分类
      - 主堆栈指针（MSP）：复位后缺省使用的堆栈指针，用于操作系统内核以及异常处理例程（包括中断服务例程）
      - 进程堆栈指针（PSP）：由用户的应用程序代码使用。
    - 注
      - Cortex‐M3 拥有两个堆栈指针，然而它们是 banked，因此任一时刻只能使用其中的一个。
      - 堆栈指针的最低两位永远是 0，这意味着堆栈总是 4 字节对齐的。
  - 连接寄存器（R14）
    - 注
      - 当呼叫一个子程序时，由 R14 存储返回地址。
  - 程序计数寄存器（R15）
    - 注
      - 指向当前的程序地址。如果修改它的值，就能改变程序的执行流。
  - 程序状态字寄存器组（PSRs）
    - 注
      - 记录 ALU 标志（0 标志，进位标志，负数标志，溢出标志），执行状态，以及当前正服务的中断号。
  - 中断屏蔽寄存器组
    - 分类
      - PRIMASK: 屏蔽所有中断（除不可屏蔽中断（NMI））
      - FAULTMASK：屏蔽所有 fault（除不可屏蔽中断（NMI））
      - BASEPRI：屏蔽优先级不高于某个具体数值的中断，设定一个门槛。
  - 控制寄存器（CONTROL）
    - 注
      - 定义特权状态并且决定使用哪一个堆栈指针。
- 操作模式
  - handler 模式：异常服务程序运行时的模式。
  - thread 模式：普通程序运行时的模式，处理器复位后默认进入此模式。
- 特权级
  - 特权级：可以访问所有范围内的存储器(除去MPU禁用的部分)；可以运行 thread 模式的程序，也可以运行 handler 模式的异常服务程序；处理器复位后默认进入特权级。
  - 用户级：只能访问和修改一部分安全的寄存器，可运行的程序不会对处理器产生破坏性的影响。
- NVIC（嵌套向量中断控制器）
  - 特性
    - 可嵌套中断：不同的中断有不同的优先级，优先级高的中断可以中断优先级低的中断服务程序。
    - 动态优先级调整：软件可以在运行时期更改中断的优先级。（防止重入？）
    - 缩短中断延迟：通过自动的现场保护和恢复，以及其它的措施。
    - 中断可屏蔽：既可以屏蔽优先级低于某个阈值的中断/异常［译注 8］ (设置 BASEPRI 寄存器)，也可以全体封杀(设置 PRIMASK 和 FAULTMASK 寄存器)。这是为了让时间关键（ time‐critical）的任务能在 deadline 到来前完成，而不被干扰。
    - NMI（不可屏蔽中断）输入脚：当它被置为有效（assert）时，NMI 服务例程会无条件地执行。
    - CM3 取消了 FIQ 的概念，支持 240 条中断之外，NVIC 还支持 16 - 4 - 1 = 11 个内部异常源，总共有 256 个预定义异常类型，但具体使用了多少个是由芯片生产商决定。
- 存储器映射
  - 地址划分
    - Code（0x0 ~ 0x1FFFFFFF 512M）：代码区、中断向量表
    - SRAM（0x20000000 ~ 0x3FFFFFFF 512M）：片上 SRAM
    - Peripherals（0x40000000 ~ 0x5FFFFFFF 512M）：片上外设
    - External RAM（0x6000000 ~ 0x9FFFFFFF 1G）：外部扩展 RAM
    - External Device（0xA0000000 ~ 0xDFFFFFFF 1G）：外部拓展设备
    - System Level（0xE0000000 ~ 0xFFFFFFFF 512M）：系统片上外设（NVIC 寄存器、MPU寄存器、调试组件）
- 总线接口
  - 分类
    - 指令存储总线：
      - I-Code：取指
      - D-Code：查表
    - 系统总线：访问内存和外设
    - 私有外设总线：主要用访问调试组件。
- MPU（存储器保护单元）
  - 功能：将某些内存区域设置为只读从而起到保护的作用。
- 指令集：由过去的 ARM + Thumb 混合指令进化为 Thumb2 指令，提高了代码密度和性能。
- 调试支持
  - Cortex-M3 在内核水平上搭载了若干种调试相关的特性,包括停机(halting)、单步执行(stepping)、指令断点、数据观察点、寄存器和存储器访问、性能速写（profiling）以及各种跟踪机制。
  - Cortex-M3 的调试系统基于 ARM 最新的 CoreSight 架构。不同于以往的 ARM 处理器，内核本身不再含有 JTAG 接口。取而代之的，是 CPU 提供称为“调试访问接口(DAP)”的总线接口。通过这个总线接口，可以访问芯片的寄存器，也可以访问系统存储器，甚至是在内核运行的时候访问！对此总线接口的使用，是由一个调试端口（DP）设备完成的。DPs 不属于 CM3 内核，但它们是在芯片的内部实现的。目前可用的 DPs 包括 SWJ-DP(既支持传统的 JTAG 调试，也支持新的串行线调试协议)，另一个 SW-DP 则去掉了对 JTAG 的支持。另外，也可以使用 ARM CoreSignt 产品家族的 JTAG-DP 模块。这下就有 3 个 DPs 可以选了，芯片制造商可以从中选择一个，以提供具体的调试接口（通常都是选SWJ-DP）。
  - CM3 还能挂载一个所谓的“嵌入式跟踪宏单元（ETM）”。ETM 可以不断地发出跟踪信息，这些信息通过一个被称为“跟踪端口接口单元（TPIU）”的模块而送到内核的外部，再在芯片外面使用一个“跟踪信息分析仪”，就可以把 TIPU 输出的“已执行指令信息”捕捉到，并且送给调试主机（PC）。
  - “指令追踪宏单元（ITM）”，它也有自己的办法把数据送往调试器。通过把数据写到 ITM 的寄存器中，调试器能够通过跟踪接口来收集这些数据，并且显示或者处理它。此法不但容易使用，而且比 JTAG 的输出速度更快。



---
Power by Internet.
- 《Cortex‐M3 权威指南》作者：Joseph Yiu 翻译：宋岩
- 《Cortex-M3 技术参考手册》
