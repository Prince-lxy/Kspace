# Cortex-M3

> Cortex-M3

## Contents / Mind mapping
- **Cortex-M3 MCU**
  - **Cortex-M3 内核**

---

### Cortex-M3 MCU

Cortex-M3 MCU（微控制器单元）包含 Cortex-M3 处理器内核、调试系统、内部总线、外设、存储器、时钟、I/O。其中的内核和调试系统由 ARM 公司设计，其他部分由生产芯片的厂商设计开发。

- Cortex-M3 MCU
  - Core Processor Unit
    - Instruction Fetch Unit（取指单元）
    - Decoder（解码器）
    - Register（寄存器）
    - ALU（逻辑运算单元）
    - NVIC Interface（嵌套向量中断控制器接口）
    - Memory Interface（存储器接口）
    - Trace Interface（跟踪接口）
  - Memory Protection Unit（存储器保护单元）
  - Bus（总线）
    - Instruction Bus（指令总线）
    - Data Bus（数据总线）
  - NVIC（嵌套向量中断控制器）
  - Debug System（调试系统）
    - ITM（指令跟踪宏单元）
    - DWT（数据观察点 & 跟踪）
    - FPB（闪存地址重载 & 断点）
    - TPIU（跟踪端口接口单元）
    - ETM（嵌入式跟踪宏单元）
    - External PPB（外部私有外设总线）

#### Cortex-M3 内核

- 架构：
  - Cortex-M3 内核是一个 32 位处理器。内部的数据路径是 32 位的，寄存器是 32 位的，存储器接口也是 32 位的。
  - CM3 采用了哈佛结构，拥有独立的指令总线和数据总线，可以让取指与数据访问并行不悖。另一方面，指令总线和数据总线共享同一个存储器空间（一个统一的存储器系统）。换句话说，不是因为有两条总线，可寻址空间就变成 8GB 了。
- 寄存器
  - 通用寄存器（R0-R12）
    - 注
      - 绝大多数 16 位 Thumb 指令只能访问 R0‐R7，而 32 位 Thumb‐2 指令可以访问所有寄存器。
  - 堆栈指针寄存器（R13）
    - 分类
      - 主堆栈指针（MSP）：复位后缺省使用的堆栈指针，用于操作系统内核以及异常处理例程（包括中断服务例程）
      - 进程堆栈指针（PSP）：由用户的应用程序代码使用。
    - 注
      - Cortex-M3 拥有两个堆栈指针，然而它们是 banked，因此任一时刻只能使用其中的一个。
      - 堆栈指针的最低两位永远是 0，这意味着堆栈总是 4 字节对齐的。
  - 连接寄存器（R14）
    - 注
      - 当呼叫一个子程序时，由 R14 存储返回地址。
  - 程序计数寄存器（R15）
    - 注
      - 指向当前的程序地址。如果修改它的值，就能改变程序的执行流。
  - 程序状态字寄存器组（xPSR）
    - 分类
      - 应用 APSR：N(31) Z(30) C(29) V(28) Q(27)
      - 中断 IPSR：ICI/IT(25~26) T(24) ICI/IT(10~15)
      - 执行 EPSR：Exception Number(0~8)
    - 注
      - APSR(27~31)、IPSR(9~26)、EPSR(0~8)分别是 xPSR 的一部分。
      - 此寄存器只能通过 MRS 和 MSR 指令来访问和设置。
  - 中断屏蔽寄存器组
    - 分类
      - PRIMASK: 屏蔽所有中断（除不可屏蔽中断（NMI）和硬 fault），这个寄存器只有一位。
      - FAULTMASK：屏蔽所有 fault（除不可屏蔽中断（NMI）），这个寄存器只有一位。
      - BASEPRI：屏蔽优先级号高于此寄存器具体数值的中断，默认值 0 表示不屏蔽任何中断。
    - 注
      - 此寄存器只能通过 MRS 和 MSR 指令来访问和设置。
  - 控制寄存器（CONTROL）
    - 分类
      - CONTROL[0]：0 表示特权级 thread 模式；1 表示用户级 thread 模式；
      - CONTROL[1]：默认值 0 表示 R13 为 MSP；1 表示 R13 为 PSP；
    - 注
      - 此寄存器只能通过 MRS 和 MSR 指令来访问和设置。
- 操作模式
  - handler 模式：异常服务程序运行时的模式。
  - thread 模式：普通程序运行时的模式，处理器复位后默认进入此模式。
- 特权级
  - 特权级：可以访问所有范围内的存储器(除去MPU禁用的部分)；可以运行 thread 模式的程序，也可以运行 handler 模式的异常服务程序；处理器复位后默认进入特权级。
  - 用户级：只能访问和修改一部分安全的寄存器，可运行的程序不会对处理器产生破坏性的影响。
- 指令集：由过去的 ARM + Thumb 混合指令进化为 Thumb2 指令，提高了代码密度和性能。

#### MPU（存储器保护单元）

- 功能：将某些内存区域设置为只读从而起到保护的作用。
- 存储器映射
  - 地址划分
    - Code（0x0 ~ 0x1FFFFFFF 512M）：代码区、中断向量表
    - SRAM（0x20000000 ~ 0x3FFFFFFF 512M）：片上 SRAM
      - Bit Band（0x20000000 ~ 0x2010000 1M）：位带区
      - Bit Band Alias（0x22000000 ~ 0x23FFFFFF 32M）：位带别名区
    - Peripherals（0x40000000 ~ 0x5FFFFFFF 512M）：片上外设
      - Bit Band（0x40000000 ~ 0x4010000 1M）：位带区
      - Bit Band Alias（0x42000000 ~ 0x43FFFFFF 32M）：位带别名区
    - External RAM（0x6000000 ~ 0x9FFFFFFF 1G）：外部扩展 RAM
    - External Device（0xA0000000 ~ 0xDFFFFFFF 1G）：外部拓展设备
    - Private peripheral bus（0xE0000000 ~ 0xE00FFFFF 1M）：私有外设总线
      - Internal（0xE0000000 ~ 0xE003FFFF 256k）
        - ITM（0xE0000000 ~ 0xE0000FFF 4k）
        - DWT（0xE0001000 ~ 0xE0001FFF 4k）
        - FPB（0xE0002000 ~ 0xE0002FFF 4k）
        - NVIC（0xE000E000 ~ 0xE000EFFF 4k）
      - External（0xE0040000 ~ 0xE0100000 768k）
        - TPIU（0xE0040000 ~ 0xE0040FFF 4k）
        - ETM（0xE0041000 ~ 0xE0041FFF 4k）
        - External PPB（0xE0042000 ~ 0xE00FEFFF 756k）
        - ROM Table（0xE00FF000 ~ 0xE00FFFFF 4k）
    - Vendor specific（0xE0100000 ~ 0xFFFFFFFF 511M）：厂商定制
- Bit Band 技术
  - 含义：在 SRAM 和 Peripherals 区域设置 1M 的位带区和 32M 的位带别名区，位带域中每一个位对应位带别名区中的一个字（4个字节），通过对位带别名区的字赋值来等效对位带区中对应位的置位和清除操作，目的是用空间换时间，因为位操作花费的时间更长。
  - 对应关系：位带区中每个位对应位带别名区的 4 个字节。
    - `位带别名区地址 = 位带别名区基地址 + 字偏移地址`
    - `字偏移地址 = 字节相对位带区的偏移 × 32 + 位 × 4`

#### 总线接口

- 分类
  - 指令存储总线
    - I-Code：取指，操作范围（0x0 ~ 0x1FFFFFFF）
    - D-Code：查表，操作范围（0x0 ~ 0x1FFFFFFF）
  - 系统总线：访问内存和外设，操作范围（0x20000000 ~ 0xDFFFFFFF | 0xE0100000 ~ 0xFFFFFFFF）
  - 私有外设总线：主要用访问调试组件。
  - 总线矩阵：连接处理器内部总线和外部设备总线的高速阵列，根据仲裁结果处理总线抢占问题。

#### NVIC（嵌套向量中断控制器）

- 异常
  - 异常类型：系统异常（0 ~ 15）、外部中断（16 ~ 255）
  - 优先级
    - **可嵌套中断**：不同的中断有不同的优先级，优先级高（数值小）的中断可以抢占（preempt）优先级低（数值大）的中断服务程序，最高抢占层级为 128 级。
    - **动态优先级调整**：软件可以在运行时期更改中断的优先级。（防止重入？）
    - **缩短中断延迟**：通过自动的现场保护和恢复，以及其它的措施，例如尾链机制。
    - **中断可屏蔽**：既可以屏蔽优先级低于某个阈值的中断/异常（设置 BASEPRI 寄存器），也可以全体封杀(设置 PRIMASK 和 FAULTMASK 寄存器)。这是为了让时间关键（ time‐critical）的任务能在 deadline 到来前完成，而不被干扰。
    - **NMI（不可屏蔽中断）输入脚**：当它被置为有效（assert）时，NMI 服务例程会无条件地执行。
    - **悬起状态寄存器**如果一个发生的异常不能被即刻响应，就称它被“悬起”(pending)。对于每个异常源，在被悬起的情况下，都会有一个对应的“悬起状态寄存器”保存其异常请求，直到该异常能够执行为止。
    - **优先级分组**：如果使用 3 个位来表达优先级（5 ~ 7），并且优先级组的值是 5（从比特5处分组），则得到 4 级抢占优先级，且在每个抢占优先级的内部有 2 个亚优先级；如果优先级分组的值小于 5，则得到 8 个抢占优先级，每个抢占优先级内部没有亚优先级，当相同优先级的多个中断同时 pending 时，优先选择异常编号小的来处理；如果优先级分组值为 7，则除了负数优先级的异常外其他所有异常的优先级都为 0，基本上算是关闭了中断嵌套的功能。
- 异常向量表
  - 异常编号	默认中断入口	中断功能		中断优先级
  - 0		0x0		MSP 初始值
  - 1		0x4		复位			-3（固定）
  - 2		0x8		NMI			-2（固定）
  - 3		0xC		硬 fault		-1（固定）
  - 4		0x10		MemManage fault
  - 5		0x14		总线fault
  - 6		0x18		用法 fault
  - 7 ~ 10	0x1C ~ 0x28		保留
  - 11		0x2C		SVC
  - 12		0x30		调试监视器
  - 13		0x34		保留
  - 14		0x38		PendSV
  - 15		0x3C		SysTick
  - 16		0x40		IRQ #0
  - 17		0x44		IRQ #1
  - 18 ~ 255	0x48 ~ 0x3FF	IRQ #2 ~ #239

#### 调试支持

- Cortex-M3 在内核水平上搭载了若干种调试相关的特性,包括停机(halting)、单步执行(stepping)、指令断点、数据观察点、寄存器和存储器访问、性能速写（profiling）以及各种跟踪机制。
- Cortex-M3 的调试系统基于 ARM 最新的 CoreSight 架构。不同于以往的 ARM 处理器，内核本身不再含有 JTAG 接口。取而代之的，是 CPU 提供称为“调试访问接口(DAP)”的总线接口。通过这个总线接口，可以访问芯片的寄存器，也可以访问系统存储器，甚至是在内核运行的时候访问！对此总线接口的使用，是由一个调试端口（DP）设备完成的。DPs 不属于 CM3 内核，但它们是在芯片的内部实现的。目前可用的 DPs 包括 SWJ-DP(既支持传统的 JTAG 调试，也支持新的串行线调试协议)，另一个 SW-DP 则去掉了对 JTAG 的支持。另外，也可以使用 ARM CoreSignt 产品家族的 JTAG-DP 模块。这下就有 3 个 DPs 可以选了，芯片制造商可以从中选择一个，以提供具体的调试接口（通常都是选SWJ-DP）。
- CM3 还能挂载一个所谓的“嵌入式跟踪宏单元（ETM）”。ETM 可以不断地发出跟踪信息，这些信息通过一个被称为“跟踪端口接口单元（TPIU）”的模块而送到内核的外部，再在芯片外面使用一个“跟踪信息分析仪”，就可以把 TIPU 输出的“已执行指令信息”捕捉到，并且送给调试主机（PC）。
- “指令追踪宏单元（ITM）”，它也有自己的办法把数据送往调试器。通过把数据写到 ITM 的寄存器中，调试器能够通过跟踪接口来收集这些数据，并且显示或者处理它。此法不但容易使用，而且比 JTAG 的输出速度更快。



---
Power by Internet.
- 《Cortex‐M3 权威指南》作者：Joseph Yiu 翻译：宋岩
- 《Cortex-M3 技术参考手册》
